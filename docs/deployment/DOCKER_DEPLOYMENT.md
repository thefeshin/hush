# HUSH Docker Deployment Guide

> Complete guide for deploying HUSH with Docker Compose

---

## Prerequisites

- Docker 24.0+
- Docker Compose 2.20+
- 2GB RAM minimum (4GB recommended)
- 10GB disk space

### Verify Installation

```bash
docker --version        # Should be 24.0+
docker compose version  # Should be 2.20+
```

---

## Quick Start

```bash
# 1. Clone the repository
git clone https://github.com/your-repo/hush.git
cd hush

# 2. Run the deployment script
./hush deploy

# 3. Save the 12-word passphrase displayed!
```

---

## Service Architecture

```
                    ┌─────────────────┐
                    │     Nginx       │
                    │  (TLS + Proxy)  │
                    │   :80, :443     │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
    ┌─────────▼─────────┐         ┌────────▼────────┐
    │     Backend       │         │    Frontend     │
    │    (FastAPI)      │         │ (Static Files)  │
    │      :8000        │         │    (Volume)     │
    └─────────┬─────────┘         └─────────────────┘
              │
    ┌─────────▼─────────┐
    │    PostgreSQL     │
    │      :5432        │
    └───────────────────┘
```

---

## Manual Deployment

### 1. Environment Setup

```bash
# Copy environment template
cp .env.example .env

# Edit with your settings (secrets are generated by ./hush deploy)
nano .env
```

### 2. SSL Certificates

```bash
# Create SSL directory
mkdir -p nginx/ssl

# Option A: Self-signed (development)
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/key.pem \
  -out nginx/ssl/cert.pem \
  -subj "/CN=localhost"

# Option B: Use mkcert (local trusted)
mkcert -install
mkcert -key-file nginx/ssl/key.pem -cert-file nginx/ssl/cert.pem localhost

# Option C: Let's Encrypt (production)
# See SSL_SETUP.md
```

### 3. Build and Run

```bash
# Build all containers
docker compose build

# Start in detached mode
docker compose up -d

# View logs
docker compose logs -f
```

---

## Container Management

### View Status

```bash
# List containers and health status
docker compose ps

# Expected output:
# NAME          STATUS                   PORTS
# postgres      Up (healthy)
# backend       Up (healthy)
# nginx         Up (healthy)             0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp
# frontend      Exited (0)               # Normal - build container
```

### Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f backend
docker compose logs -f nginx

# Last 100 lines
docker compose logs --tail=100 backend
```

### Restart Services

```bash
# Restart all
docker compose restart

# Restart specific service
docker compose restart backend
```

### Stop Services

```bash
# Stop (keeps volumes)
docker compose stop

# Stop and remove containers (keeps volumes)
docker compose down

# Stop and remove everything including volumes (DATA LOSS!)
docker compose down -v
```

---

## Volume Management

### Data Volumes

| Volume | Purpose | Persistent |
|--------|---------|------------|
| `postgres_data` | Database files | Yes |
| `frontend_dist` | Built frontend | No (rebuilt) |

### Backup Data Volume

```bash
# Using backup script
./scripts/backup.sh

# Manual backup
docker compose exec postgres pg_dump -U hush -d hush > backup.sql
```

### Restore Data Volume

```bash
# Using restore script
./scripts/restore.sh ./backups/hush_backup_YYYYMMDD_HHMMSS.sql.gz

# Manual restore
cat backup.sql | docker compose exec -T postgres psql -U hush -d hush
```

---

## Updating HUSH

### Standard Update

```bash
# Pull latest code
git pull

# Rebuild and restart
docker compose build
docker compose up -d
```

### Update with Database Migration

```bash
# Stop services
docker compose stop

# Backup database first!
./scripts/backup.sh

# Rebuild
docker compose build

# Start services (schema auto-applies on backend startup)
docker compose up -d
```

---

## Resource Limits

Default memory limits (configurable in docker-compose.yml):

| Service | Memory Limit |
|---------|-------------|
| PostgreSQL | 512MB |
| Backend | 256MB |
| Nginx | 128MB |

### Adjust Limits

```yaml
# In docker-compose.yml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 512M  # Increase if needed
```

---

## Health Checks

All services have health checks configured:

```bash
# Check health status
docker compose ps

# Manual health check
curl -k https://localhost/health
curl -k https://localhost/api/health/ready
```

### Health Endpoints

| Endpoint | Purpose |
|----------|---------|
| `/health` | Nginx liveness |
| `/api/health` | Backend liveness |
| `/api/health/db` | Database connectivity |
| `/api/health/ready` | Full readiness probe |

---

## Network Configuration

### Internal Network

All services communicate on the internal `hush_network`. Only Nginx exposes ports externally.

### Exposed Ports

| Port | Service | Protocol |
|------|---------|----------|
| 80 | Nginx | HTTP (redirects to HTTPS) |
| 443 | Nginx | HTTPS |

### Change Ports

```yaml
# In docker-compose.yml
services:
  nginx:
    ports:
      - "8080:80"   # Change external HTTP port
      - "8443:443"  # Change external HTTPS port
```

---

## Troubleshooting

See [TROUBLESHOOTING.md](../operations/TROUBLESHOOTING.md) for common issues and solutions.

### Quick Fixes

```bash
# Container won't start
docker compose logs <service>

# Database issues
docker compose exec postgres pg_isready -U hush -d hush

# Rebuild from scratch
docker compose down
docker compose build --no-cache
docker compose up -d
```
